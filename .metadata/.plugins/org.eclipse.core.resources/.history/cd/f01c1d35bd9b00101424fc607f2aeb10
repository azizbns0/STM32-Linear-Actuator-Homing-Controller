/*
 * hw_simulation.c
 *
 *  Created on: Sep 25, 2025
 *      Author: azizb
 */

/*
 * hw_simulation.c
 */

#include "homing_porting.h"
#include "stm32f4xx_hal.h"
#include <stdbool.h>

// Simulation state
static uint32_t move_start = 0;
static bool moving_left = false;
static bool moving_right = false;
static bool left_switch = false;
static bool right_switch = false;
static bool has_reached_right = false;  // Track if we've ever reached right switch

// Travel times
#define TIME_TO_LEFT_MS        2000   // 2s to hit left (first trip)
#define TIME_TO_RIGHT_MS       2000   // 2s to hit right
#define TIME_BACK_TO_LEFT_MS   2000   // 2s to return left

uint32_t HW_GetTickMs(void) {
    return HAL_GetTick();
}

bool HW_LeftSwitchRaw(void)  {
    return left_switch;
}

bool HW_RightSwitchRaw(void) {
    return right_switch;
}

void HW_ActuatorMoveLeft(void) {
    moving_left = true;
    moving_right = false;
    move_start = HAL_GetTick();
    left_switch = right_switch = false;
    // Don't modify has_reached_right here - it tracks history
}

void HW_ActuatorMoveRight(void) {
    moving_left = false;
    moving_right = true;
    move_start = HAL_GetTick();
    left_switch = right_switch = false;
    // Don't reset has_reached_right - we need to remember we've been right
}

void HW_ActuatorStop(void) {
    moving_left = false;
    moving_right = false;
}

void HW_SimulationUpdate(uint32_t now) {
    uint32_t elapsed = now - move_start;

    if (moving_left) {
        if (!has_reached_right) {
            // First trip left (initial homing)
            if (elapsed >= TIME_TO_LEFT_MS) {
                left_switch = true;
                moving_left = false;
            }
        } else {
            // Returning from right
            if (elapsed >= TIME_BACK_TO_LEFT_MS) {
                left_switch = true;
                moving_left = false;
            }
        }
    }

    if (moving_right) {
        if (elapsed >= TIME_TO_RIGHT_MS) {
            right_switch = true;
            moving_right = false;
            has_reached_right = true;  // Mark that we've reached right
        }
    }
}
bool Debug_IsMovingLeft(void) {
    return moving_left;
}

bool Debug_IsMovingRight(void) {
    return moving_right;
}

bool Debug_HasReachedRight(void) {
    return has_reached_right;
}

uint32_t Debug_GetElapsedTime(void) {
    return HAL_GetTick() - move_start;
}

/* Add these declarations to homing_porting.h */
bool Debug_IsMovingLeft(void);
bool Debug_IsMovingRight(void);
bool Debug_HasReachedRight(void);
uint32_t Debug_GetElapsedTime(void);
